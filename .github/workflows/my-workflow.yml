on:
  pull_request: {}
  push: {}
  workflow_dispatch:
    inputs:
      test:
        type: choice
        required: false
        default: "-"
        options: ["a", "-"]

env:
  ENV: PROD
  test: ${{inputs.test != '-' && inputs.test || '' }}

jobs:
  my-job0:
    runs-on: ubuntu-22.04
    steps:
      - run: |
          # branch or tag
          echo "ref_type: $ref_type"
          # ブランチ名 / tag名
          echo "ref_name: $ref_name"
          # refs/heads/main 
          echo "ref: $ref"
          echo "sha: $sha"
          echo "event_name: $event_name"
          echo "pullrequest_number: $pullrequest_number"
          echo "merge_commit_sha: $merge_commit_sha"

          gh 
        env:
          ref_type: ${{github.ref_type}}
          ref_name: ${{github.ref_name}}
          ref: ${{github.ref}}
          sha: ${{ github.sha }}
          event_name: ${{ github.event_name }}
          pullrequest_number: ${{ github.event.pull_request.number }}
          merge_commit_sha: ${{ github.event.pull_request.merge_commit_sha }}
          GH_TOKEN: ${{ github.token }}
  shard-job:
    runs-on: ubuntu-22.04
    continue-on-error: true
    outputs:
      conclusion: ${{ steps.test-step.conclusion }}
      outcome: ${{ steps.test-step.outcome }}
      result: ${{ steps.test-step.outputs.result }}
    strategy:
      matrix:
        num: [0, 1]
    steps:
      - name: Test step
        id: test-step
        env:
          X: ${{matrix.num}}
        continue-on-error: true
        run: |
          if [ $X -gt 0 ]; then
            echo success
            echo "result=success" >> $GITHUB_OUTPUT
            exit 0
          else
            sleep 30
            echo failure
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
  after:
    needs: ["shard-job"]
    runs-on: ubuntu-22.04
    steps:
      - env:
          job_result: ${{ needs.shard-job.result }}
          conclusion: ${{ needs.shard-job.outputs.conclusion }}
          outcome: ${{ needs.shard-job.outputs.outcome }}
          result: ${{ needs.shard-job.outputs.result }}
        run: |
          echo "job_result: $job_result"
          echo "conclusion: $conclusion"
          echo "outcome: $outcome"
          echo "result: $result"
      
